<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc PUBLIC "-//IETF//DTD RFC 2629//EN"
"http://xml.resource.org/authoring/rfc2629.dtd" [
<!ENTITY RFC2119 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC2617 PUBLIC "" "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2617.xml">
<!ENTITY UMA PUBLIC "" "http://kantarainitiative.org/confluence/display/uma/Home">
<!ENTITY UMAreqs PUBLIC "" "http://kantarainitiative.org/confluence/display/uma/UMA+Requirements">
<!ENTITY RFC3552 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.3552.xml">

]>

<rfc category="std" docName="draft-uma-core-v1-00-Rev6.txt" ipr="trust200902">
  <?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>

  <?rfc toc='yes' ?>

  <?rfc tocdepth='3' ?>

  <?rfc symrefs='yes' ?>

  <?rfc sortrefs='yes' ?>

  <?rfc compact='yes' ?>

  <?rfc subcompact='no' ?>

  <?rfc strict='yes' ?>

  <front>
    <title abbrev="UMA Core Protocol">User-Managed Access (UMA) Core
    Protocol</title>
    
    <author fullname="Thomas Hardjono" initials="T" role="editor"
      surname="Hardjono">
      <organization>MIT</organization>
      
      <address>
        <email>hardjono@mit.edu</email>
      </address>
    </author>

    <author fullname="Christian Scholz" initials="C" surname="Scholz">
      <organization>COM.lounge GmbH</organization>

      <address>
        <email>cs@comlounge.net</email>

        <uri>http://comlounge.net</uri>
      </address>
    </author>

    <author fullname="Paul Bryan" initials="P" surname="Bryan">
      <organization>?</organization>

      <address>
        <email>email@pbryan.net</email>

        <uri>http://pbryan.net</uri>
      </address>
    </author>

    <author fullname="Maciej Machulak" initials="M" surname="Machulak">
      <organization>Newcastle University</organization>

      <address>
        <email>m.p.machulak@ncl.ac.uk</email>

        <uri>http://ncl.ac.uk/</uri>
      </address>
    </author>

    <author fullname="Eve Maler" initials="E" surname="Maler">
      <organization>PayPal</organization>

      <address>
        <email>eve@xmlgrrl.com</email>

        <uri>http://www.paypal.com/</uri>
      </address>
    </author>

    <date year="2011" />

    <abstract>
      <t>This specification defines the User-Managed Access (UMA) core
      protocol. This protocol provides a method for users to control access to
      their protected resources, residing on any number of host sites, through
      an authorization manager that makes access decisions based on user
      policy.</t>

      <t>This document is a product of the User-Managed Access Work Group of
      the Kantara Initiative. It is currently under active development. It has
      not yet been submitted to the IETF. The User-Managed Access Work Group
      operates under Kantara IPR Policy - Option Patent and Copyright:
      Reciprocal Royalty Free with Opt-Out to Reasonable And Non
      discriminatory (RAND) and the publication of this document is governed
      by the policies outlined in this option.</t>
    </abstract>
  </front>



  <middle>
    
    <section title="Introduction">
      <t>The User-Managed Access (UMA) core protocol provides a method, based
      on <xref target="OAuth2" /> (currently draft 10), for users to control
      access to their protected resources, residing on any number of Host
      sites, through an Authorization Manager (AM) that makes access decisions
      based on User policy.</t>

      <t>For example, a web user (authorizing User) can authorize a web app
      (Requester) to gain one-time or ongoing access to a resource containing
      his home address stored at a "personal data store" service (Host), by
      telling the Host to act on access decisions made by his authorization
      decision-making service (authorization manager or AM). The requesting
      party might be an e-commerce company whose site is acting on behalf of
      the user himself to assist him/her in arranging for shipping a purchased
      item, or it might be his friend who is using an online address book
      service to collect addresses, or it might be a survey company that uses
      an online service to compile population demographics.</t>

      <t>In enterprise settings, application access management often involves
      letting back-office applications serve only as policy enforcement points
      (PEPs), depending entirely on access decisions coming from a central
      policy decision point (PDP) to govern the access they give to
      requesters. This separation eases auditing and allows policy
      administration to scale in several dimensions. UMA makes use of this
      separation, letting the authorizing user serve as a policy administrator
      crafting authorization strategies on his or her own behalf.</t>

      <t>The UMA protocol profiles and extends <xref target="OAuth2" />,
      applying two (2) instances of OAuth flow patterns among the entities.</t>

      <t>First, UMA allows a Host to establish mutual trust with
      an AM to which it has been
      introduced dynamically by the User. 
      To accomplish this, the Host acquires a host
      access token that it can subsequently use in interacting with a set of
      Host-specific protected resources at the AM. These resources can be
      considered an OAuth-protected API. Thus, when the Host accesses these
      resources (at the AM), it acts in the role of an OAuth client while the AM acts in
      the dual roles of an OAuth resource server and OAUTH authorization server.</t>

      <t>Secondly, when a Requester interacts with the AM and the Host in
      the course of getting access to some protected resource on the Host, the
      Requester acts in the role of an OAuth client to obtain (and thereafter use) 
      a requester access token. Here the Host acts in the role of an OAuth resource server,
      while the AM acts in the role of an OAuth authorization server.</t>

      <t>Following the above two instances of OAuth flow patterns,
        UMA has the following two broad phases, each of which consists
        of steps (described further below):
        <list style="numbers">
          <t>Protection of a Resource (Phase I):
            Here authorizing User introduces a Host to an AM.
            In this phase the Host itself must obtain a host access token from the AM,
            which the Host can subsequently use in interactions with the AM.
            This phase is completed when the Host has registered to the AM 
            the resources which it seeks to be protected.
          </t>

          <t>Obtaining authorization and access to resource (Phase II):
            In this phase the Requester first gets an access token from the AM. 
            This is folowed by the Requester wielding the access token to the Host
            to gain access to desired resourecs at the Host.</t>
        </list></t>
      
      <t>In the following sections, the steps involved within each
      phase is further discussed and some examples are provided for
      clarity.</t>
      
      

      <section title="Notational Conventions">
        <t>The key words 'MUST', 'MUST NOT', 'REQUIRED', 'SHALL', 'SHALL NOT',
        'SHOULD', 'SHOULD NOT', 'RECOMMENDED', 'MAY', and 'OPTIONAL' in this
        document are to be interpreted as described in <xref
        target="RFC2119" />.</t>

        <t>This document uses the Augmented Backus-Naur Form (ABNF) notation
        of <xref target="ID-ietf-httpbis-p1-messaging" />. Additionally, the
        realm and auth-param rules are included from 
          <xref target="RFC2617" />.</t>

        <t>Unless otherwise noted, all the protocol parameter names and values
        are case sensitive.</t>
      </section>

      <section title="Terminology">
        <t>
          <list hangIndent="6" style="hanging">
            <t hangText="authorizing user"><vspace />An UMA-defined variant of
            an OAuth resource owner; a web user who configures an
            authorization manager with policies that control how it makes
            access decisions when a requester attempts to access a protected
            resource at a host.</t>

            <t hangText="authorization manager"><vspace />An UMA-defined
            variant of an OAuth authorization server that carries out an
            authorizing user's policies governing access to a protected
            resource.</t>

            <t hangText="protected resource"><vspace />An access-restricted
            resource at a host.</t>

            <t hangText="host"><vspace />An UMA-defined variant of an OAuth
            resource server that enforces access to the protected resources it
            hosts, as decided by an authorization manager.</t>

            <t hangText="host access token"><vspace />An access token
            representing the authorizing user's consent for a host to trust a
            particular authorization manager for access decisions about
            resources hosted there.</t>

            <t hangText="claim"><vspace />A statement of the value or values
            of one or more identity attributes of a requesting party. Claims
            are conveyed by a requester on behalf of a requesting party to an
            authorization manager in an attempt to satisfy an authorizing
            user's policy.</t>

            <t hangText="requester"><vspace />An UMA-defined variant of an
            OAuth client that seeks access to a protected resource.</t>

            <t hangText="requester access token"><vspace />An access token
            representing the authorizing user's consent for a requester's
            access to particular resources at a host.</t>

            <t hangText="requesting party"><vspace />A web user, or a
            corporation (or other legal person), that uses a requester to seek
            access to a protected resource.</t>
          </list>
        </t>
      </section>
      
    </section>


 <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --> 
    
    <section title="Phase I: Protecting a Resource">
      
      <t>In order for a Host to be able to delegate authorization to an AM,
      the authorizing User must introduce the Host to the AM.
      A successful conclusion of this phase is denoted by the following
      results:
        <list style="symbols">
          <t>The Host has received metadata about the AM, such as OAuth
          endpoints.</t>
          
          <t>The AM has received metadata about the Host, such as
            endpoints which the Requster must use to gain access to resources.</t>

          <t>The Host has received an OAuth access token (known as the host
          access token) that represents the authorizing User's approval for
          the Host to work with a given AM in protecting resources. 
          This host access token is used when the Host makes requests
          at host-specific AM endpoints.</t>

          <t>The AM has optionally acquired information about scopes on the
          Host it is supposed to protect on behalf of the User.</t>
        </list></t>

      <t>The following substeps are performed by the User, Host and AM 
        in order to successfully complete the first phase: 
        <list style="numbers">
          <t>The Host looks up the AM's metadata and learns about its API
          endpoints and supported formats.</t>

          <t>If the Host has not yet obtained an OAuth client identifier and
          optional secret from the AM, it registers with and binds to the AM
          dynamically, for example via the UMA dynamic registration protocol
          (see <xref target="Dyn-Reg">Dyn-Reg</xref>).</t>

          <t>The Host obtains a host access token from the AM with the authorizing
          User's consent, by following the OAuth 2.0 web server profile.</t>

          <t>The Host optionally registers scopes with the AM that are
          intended to be protected, via [[draft-uma-resource-reg]].</t>
        </list></t>


      <section title="Host looks up AM metadata">
        <t>The Host needs to learn the OAuth- and UMA-related endpoints of the
        AM before they can begin interacting. The authorizing User might
        provide the AM's location to get the Host started in this process, for
        example by typing a URL into a web form field or clicking a button.
        Alternatively, the Host might already be configured to work with a single AM without
        requiring any user input. The exact process is beyond the scope of
        this specification, and it is up to the Host to choose a method
        to learn the AM's location.</t>

        <t>From the data provided, discovered, or configured, the host MUST
        retrieve the hostmeta document as described in Section 2 of <xref
        target="hostmeta">hostmeta</xref>. For example, if the user supplied
        "am.example.com" as the Authorization Manager's domain, the host
        creates the URL "https://am.example.com/.well-known/host-meta" and
        performs a GET request on it.</t>


        <section title="The AM End-Points">
        <t>The AM MUST provide a XRD 1.0 formatted document at the hostmeta
        location, documenting the following: <list style="symbols">
            <t>One set of OAuth 2.0 end-user authorization and token endpoints
            for the host to use</t>

            <t>One set of OAuth 2.0 end-user authorization and token endpoints
            for requesters to use, which the host will need to provide to
            unauthorized requesters</t>

            <t>Optionally, the location of an UMA token validation endpoint
            for the host to use in validating access tokens received from a
            requester in step 3</t>

            <t>At least one access token format the AM produces</t>

            <t>Any claims formats the AM supports</t>
          </list></t>

        <t>(Note that the method of endpoint discovery defined here is
        intended to be compatible with the ultimate dynamic discovery,
        registration, and binding solution proposed by the OAuth group. The
        UMA group has proposed a generic solution at <xref
        target="Dyn-Reg">Dyn-Reg</xref>, with which this discovery step is
        compatible.)</t>

        <t>Property type values for access token and claim format information:
        <list hangIndent="6" style="hanging">
            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/token_formats"><vspace />
            REQUIRED (one or more). Access token format produced by this AM.
            Options are (@@TBS).</t>

            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/claim_formats"><vspace />
            OPTIONAL (zero or more). Claim format supported by this AM.
            Options are (@@TBS).</t>
          </list></t>

        <t>Link relationship rel values for the endpoint URLs for the host:
        <list hangIndent="6" style="hanging">
            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/host_user_uri"><vspace />REQUIRED.
            Available HTTP methods are as defined by [[OAuth20]] for an
            end-user authorization endpoint. Supplies the endpoint hosts
            should use to gather the consent of the authorizing user for a
            host-AM relationship.</t>

            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/host_token_uri"><vspace />REQUIRED.
            Available HTTP methods are as defined by [[OAuth20]] for a token
            issuance endpoint. Supplies the endpoint hosts should use to ask
            for a host access token.</t>

            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/host_registration_uri"><vspace />REQUIRED.
            Supports the POST HTTP method, accompanied by a host access token.
            Supplies the endpoint hosts should use for registering information
            with the AM, such as descriptions of resources that are to be
            protected by this AM (as defined in [[draft-uma-resource-reg]]).
            The AM SHOULD require the use of a transport-layer security
            mechanism such as TLS when the host sends requests to the host
            registration endpoint.</t>

            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/host_token_validation_uri"><vspace />OPTIONAL.
            Supports the POST HTTP method, accompanied by a host access token.
            Supplies the endpoint hosts should use to request validation of
            access tokens presented to them by requesters in Step 3. This
            endpoint SHOULD require the use of a transport-layer security
            mechanism such as TLS.</t>
          </list></t>

        <t>Link relationship rel values for the endpoint URLs for the
        requester: <list hangIndent="6" style="hanging">
            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/req_user_uri"><vspace />
            REQUIRED. Available HTTP methods are as defined by <xref
            target="OAuth2" /> for a user authorization URL. Supplies the user
            authorization URL requesters should use to gather the consent of
            the authorizing user for user delegation flows in synchronous
            person-to-service sharing scenarios. (See Section @@TODO for the
            definition of this UMA-specific client profile.) This endpoint
            SHOULD require the use of a transport-layer security mechanism
            such as TLS.</t>

            <t
            hangText="http://kantarainitiative.org/confluence/display/uma/req_token_uri"><vspace />
            REQUIRED. Available HTTP methods are as defined by <xref
            target="OAuth2" /> for a token issuance URL. Supplies the token
            URL requesters should use to ask for an access token in step 2.
            This endpoint SHOULD require the use of a transport-layer security
            mechanism such as TLS.</t>
          </list></t>

        </section>
        
        <section title="Example">
        <figure>
          <preamble>For example:</preamble>

          <artwork><![CDATA[
      
<!-- Applies to both hosts and requesters --> 
<Property 
  type="http://wguma.org/confluence/display/uma/token_formats">
  saml
</Property>
<Property 
  type="http://wguma.org/confluence/display/uma/claim_formats">
  json
</Property>

<!-- Host "authorization API" --> 
<Link 
rel="http://wguma.org/confluence/display/uma/host_token_uri"
href="https://am.example.com/host/token_uri"></Link> 
<Link 
rel="http://wguma.org/confluence/display/uma/host_user_uri"
href="https://am.example.com/host/user_uri"></Link> 
<<<<<<< HEAD
<Link 
rel="http://wguma.org/confluence/display/uma/host_resource_details_uri"
=======
<Link rel="http://kantarainitiative.org/confluence/display/
                                      uma/host_registration_uri"
>>>>>>> b739d760a257c5b06aff0e1b0b7a962418425a08
href="https://am.example.com/host/resource_details_uri"></Link> 
<Link 
rel="http://wguma.org/confluence/display/uma/host_token_validation_uri"
href="https://am.example.com/host/token_validation_uri"></Link> 

<!-- Requester token-getting endpoints --> 
<Link rel="http://wguma.org/confluence/display/uma/req_token_uri"
href="https://am.example.com/requester/token_uri"></Link> 
<Link rel="http://wguma.org/confluence/display/uma/req_user_uri"
href="https://am.example.com/requester/user_uri"></Link>

       ]]></artwork>
        </figure>
        </section>
        
      </section>


      <section title="Host dynamically registers with AM">
        <t>If the Host has not already obtained a client identifier and
        optional secret from this AM previously, in this step it MUST do so
        in order to engage in OAuth-based interactions with the AM.
        This should be preferably using the UMA dynamic registration protocol. 
        (see <xref target="Dyn-Reg">Dyn-Reg</xref>).</t>
      </section>


      <section title="Host obtains host access token">
        <t>In this step, the Host acquires a host access token from the AM
        that represents the approval of the authorizing User for the Host to
        trust the AM for protecting resources belonging to the User.</t>

        <t>The Host MUST use the <xref target="OAuth2">OAuth2</xref> web
        server profile (@@TODO: subsequently profile it to use UMA recursively
        for claims-getting purposes?), utilizing the end-user authorization
        and token endpoints discovered earlier. Here the Host acts in the role of
        an OAuth client. The authorizing User acts in the role of an OAuth
        end-user resource owner. The AM, through the provided endpoint
        URLs, acts in the role of an OAuth authorization server.</t>
        
        <t>A succesful completion of this step is signfified by the Host
        possesing a host access token for use at the authorized AM.</t>
      </section>



      <section title="Host registers resources to be protected">
        <t>Once the Host has received a host access token (in the previous step), it MAY
        immediately (or at any time until user authorization is revoked)
        present the token at the AM's host_registration_uri endpoint in order to register
        resources which the AM needs to protect.
        This is done in the manner defined in [[draft-uma-resource-reg]].</t>

        <t>Note that the Host is free to offer the option to protect any
        subset of the user's resources using different AMs or other means
        entirely, or to protect some resources and not others; any such
        partitioning by the host or user is outside the scope of this
        specification.</t>
      </section>
      
    </section>


    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --> 
    
    
    
    <section title="Phase II: Obtaining Authorization and Getting Access to Resources">
      <t>This phase describes the various possible scenarios
          relating to the Requester obtaining authorization from the AM
          to access a resource (resource set) at the Host.
        </t>

        <t>
        The phase begins with the Requester attempting
        access to the resource at the Host,
        but without success (due to either the requester not possesing
        any access token or that the presented token was invalid).
      </t>
      
      <t>This phase is completed when the Requester
        has successfully obtained authorization
        from the AM, as indicated by the Requester
        obtaining an access token from the AM with the correct
        scope (to gain access to the desired resource at the Host).
      </t>
      
      <t>
        Note that this phase extends Oauth in two notable ways.  
        Firstly, in this step the Host upon receiving an access request from the Requester
        will perform a "scopes registration" to the AM. 
        This essentially lets the AM know ahead of time
        which resources and scopes are being sought by the Requester.
        Secondly, this step extends Oauth by allowing the AM to ask
        the Requester by asking it for further information in the form claims.
        Aspects of these extensions will be further discussed below.
      </t>
      
      <t>This Phase has the following assumptions:
        <list style="numbers">
          <t>Assumption 1.</t>
          
          <t>Assumption 2.</t>
        </list></t>
      
      <t>This phase has the following steps: 
        <list style="numbers">
        <t>Requester approaches the Host to attempt access
        to a protected resource.</t>
        
        <t>Host requests token validation to the AM.</t>
        
        <t>Host performs a requested-scope registration to the AM.</t>
        
        <t>Requester asks AM to grant an authorization for the scope.</t>
        
      </list></t>
      
      <t>The step detail are further describe below.</t>
      
      
      
      <section title="Requester approaches the Host to attempt access">
        <t>In normal operational circumstaces the Requester is expected
          to attempt to access the desired resource (or resource set) at the Host directly
          (e.g. clicking on a thumbnail representation of the resource).
        </t>
        
        <t>In this event we assume the following:
          <list style="symbols">
              <t>The Requester is already in the posession of knowledge regarding
              the relevant resource end-point at the Host.
              </t>
              
              <t>In the absence of knowledge about the Host's end-point,
                we assume that the Requester has the ability to perform
                discovery of the Host's end-point.
                See Section 2.1 above.
              </t>
          </list>
        </t>
        
        <section title="Requester has no token or token invalid">
            <t>If the Requester does not present any token with the request,
              the Host SHOULD return an HTTP 400 status code indicating
              it is an "invalid_request" [REF: Section 2.4.1 of Oauth Bearer Token draft].
              This indicates to the Requester one of the following: that
              the request is missing a required parameter, that it includes an
              unsupported parameter or parameter value, that it repeats the same
              parameter, that it uses more than one method for including an access
              token, or that it is otherwise malformed.
            </t>

              <t>If the Requester does present a token with its request but
                the token is invalid, then the Host SHOULD return an HTTP 401 status code indicating
                it is an "invalid_token" [REF: Section 2.4.1 of Oauth Bearer Token draft].
                This indicates to the Requester that
                the access token provided is expired, revoked, malformed, or
                invalid for other reasons. In this case the Requester
                may request a new access token (See Section XYZ below).
              </t>
        </section>
        
        
        <section title="Requester's token has insufficient scope">
            <t>If the Requester's token does not have a sufficient scope
              with regards to the desired resource,
              the Host SHOULD respond with the HTTP 403 (Forbidden) status code
              indicating that the token has "insufficient_scope"
              [REF: Section 2.4.1 of Oauth Bearer Token draft].
              In this case the Requester
              may request a new access token (See Section XYZ below).
            </t>
        </section>
        
        <section title="Requester's token has sufficient scope">
            <t>If the requester's token has sufficient scope
               the Host gives access to the desired resource.
            </t>
        </section>
        
        <section title="Requester's request is ambiguous">
          <t>If the requester's request is ambiguous with respect to the specific
            User at the Host, the Host responds with "ambiguous-user error" message.
          </t>
        </section>
        
        <section title="Examples">
          <t>TBD.
          </t>
        </section>
        
      </section>
      
      
      <section title="Host requests token validation to AM">
        <t>Upon receiving the Requester access token in the
          access request, the Host asks the AM to validate this token.
          In UMA architecture the task of validating
          a Requester's token is performed by the AM on behalf
          of the Host.</t>
        
        <t>In order to reduce the risk on the part of the AM
          from denial-of-service attacks, where
          arbitrary tokens are sent to the AM's token validation end-point,
          the Host must also submit its own Host token.
          The Host's access token proves that the Host is authorized
          by the AM to use the AM's token validation end-point.
          Furthermore, it allows the Host and AM to uniquely identify
          the User which they have in common, and therefore
          allows the AM to look-up the correct User policies
          pertaining to the User's resource sets and permissible actions.
        </t>
        
        <t>In this event we assume the following:
          <list style="symbols">
            <t>The Host is assumed to be able to disambiguate (from the nature
              of the requester's access request) which User has
              jurisdiction or ownership over the requested resource.
            </t>
            
            <t>The token validation end-point belonging
              to the AM is advertised in the XRD file of the
              at a well know location.
            </t>
            
            <t>Message type: POST  (NB: to be confirmed).
            </t>
          </list>
        </t>
        

          
        <t>The Host sends the token validation request
              to the AM's token validation end-point.
              The request must carry:
              <list style="symbols">
                <t>The Host access token: this is the access token
                  obtained by the Host from the AM during the
                  registration of the Host to the AM (in the previous phase).
                </t>
                <t>The Requester's token: this is the target token
                  to be validated by the AM.
                </t>
              </list>
            </t>
          
        <section title="AM Returns a token invalid response">
          <t>If the the AM find the token to be invalid for one
          reason or another, the AM will return
          a UMA error message (with HTTP success) to indicate
          that the Requester's token is invalid.
          </t>
        </section>
        
        <section title="AM Returns a token valid response">
          <t>If the the AM find the token to be valid,
            the AM returns UMA success (with HTTP success) which indicates
            to the Host that the Requester's token is valid.
            In this case the AM also returns a scope manifest
            to the Host with the success indicator.
          </t>
          
            <t>The scope manifest contains a list of scopes that applies to this given
              Requester access token. The response uses a JSON document inside the
              body of an HTTP response using the 200 OK status code. The scopes come
              from a list of strings previously registered with the AM by the host
              (as specified in Step XYZ above).</t>
            
            <figure>
              <preamble>Example:</preamble>
              
              <artwork><![CDATA[
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store

{
"scopes": ['read_private_photos', 'write_private_photos']
}       ]]></artwork>
            </figure>
            
            <t>The host MUST validate if one of the scopes is sufficient for
              requester to access the requested resource in the manner originally
              attempted. If it is, the host gives access in that manner.</t>
            
        </section>

        
        <section title="Example">
        <t>The host's request to the AM is made with a POST containing the
          requester access token and the IP address of the requester's request.
          (The host MAY, at its discretion, instead supply the originating IP
          address indicated in the requester's X-Forwarded-For: header value.)
          The POST uses the "application/x-www-form-urlencoded" format as
          defined by [W3C.REC-html401-19991224]. The IP address or originating
          IP address is advisory only; the AM MAY ignore it for token validation
          purposes.</t>
        
        <figure>
          <preamble>Example of a request to the token verification endpoint
            that provides the host access token in the header:</preamble>
          
          <artwork><![CDATA[
POST /token_verification HTTP/1.1
Host: am.example.com
Authorization: OAuth vF9dft4qmT
Content-Type: application/x-www-form-urlencoded     

token=sbjsbhs(/SSJHBSUSSJHVhjsgvhsgvshgsv&ipaddr=192.168.1.1
       ]]></artwork>
        </figure>
      </section>
      </section>
      
      <section title="Host performs a requested-scope registration to the AM">
        <t>The scope request registration from the Host to the AM 
          has the folowing inputs:
          <list style="symbols">
            <t>The host access token belonging to the Host,
              which it obtained earlier during the Host registration step (see Section XYZ above).
            </t>
            
            <t>A reference to a previously registered resource set ID (prsID) to which the Requester
              is seeking access.
            </t>
            
            <t>One or more actions (represented by a URI) which the Requester attempted to make
              to the desired resource set ID (prsID).
            </t>
            
            <t>The Requester's access token (if it was present) which it
              presented during the access attempt.
            </t>
          </list>
        </t>
        
        <t>Upon receiving the scope registration request from the Host,
          the AM issues a response message that has one of the possible
          following outputs:
          <list style="symbols">
            <t>UMA Success indicator: a scope request ticket,
              which typically has a short life-time.
              This indicator may be accompanied by a HTTP Success indicator.
            </t>
            
            <t>UMA Failure indicator: indicating a malformed scope registration request.
              This indicator may or may not be accompanied by a HTTP Success indicator.
            </t>
          </list>
        </t>
      
      </section>
      
      
      <section title="Requester asks AM to grant an access token for scope">
        
        <t>In this step the Requester asks the AM for an access token
        to the desired resource (resource stes) located at the Host.
        The Requester must also indicate the desired scope in this request.</t>
        
        <t>[NOTE:  The Requester submits a GET request to the access token URL, 
          providing the desired scope of access in the "scope" parameter. 
          [@@TBS: Rework this to describe how the desired scope information 
          is provided (e.g. whether it is in plain text or is passed through 
          in protected form from the host) and whether there are 
          extension points to allow other information to be provided. Provide code examples.]
        </t>
        
        <t>
          The Requester performs a GET on the access token URL, 
          using the standard HTTP "Accept" header to express the 
          acceptable media type(s) of any claims-required list.
        </t>
      
        <t>The AM responds in one of three ways:
          <list style="symbols">
            <t>If the AM requires no claims from the Requester in order 
                to grant authorization based on user policy, 
                it responds with a successful OAuth access token response. 
                The response MAY include a refresh token URL for the Requester 
                to attempt to use subsequently in reusing this authorization 
                to generate future access tokens.
            </t>
            
            <t>If the Requester is definitively not authorized according to user policy, 
                the AM responds with an unsuccessful OAuth access token response 
                and the authorization request phase ends.
            </t>
            
            <t> If user policy demands more information from the Requester, 
                the AM responds with a claims-required response containing a claims-required list. 
                The list SHOULD use the media type that was indicated by the requester as acceptable.

            </t>
          </list>
        </t>
      
        <t>If in this step User policy demands more information from the Requester
          and the requester received claims-required response,
          then the requester needs to satisfy all the claims listed there.
          Once the Requester completes preparing the claims document,
          it performs a POST of that document to the authorization negotiation URL,
          specifying its type in the "Content-Type" header.        
        </t>
        
        <t>If the content-type is not recognized by the AM, the AM
          will reject the document.
          [NOTE: what happens then?]  </t>
          
          <t>If the AM accepts the claims document submitted by the Requester,
          the AM responds with a successful or unsuccessful access token
          response, or with another claims-required response.
          [Eventually need a special claims response that allows for the
          trusted-claims model to unfold.]</t>
        
        <t>If the access token request is successful, the AM responds
          with an access token.  This token
          MUST be in one of the formats contemporaneously advertised in the AM's
          host-meta metadata.</t>
        
        <t>This specification does not define the formats of required-claims
          lists and claims documents. It may ultimately put minimum conformance
          requirements on requesters and AMs to handle particular claim formats
          defined in other specifications, as well as specifying requirements that
          claim formats seeking consideration for use in UMA must meet. One
          candidate specification for lightweight claims requests and responses is
          <xref target="Claims2.0">Claims2.0</xref>.</t>
        
      </section>
      

      <section title="Requester access is granted/denied">
        <t>Depending on the response from theAM
        regarding the validation of the Requester's access token,
        the Host responds to the Requester by either granting
        access to the desired resource, or denying the access.</t>
        
        <t>If the token validation by the AM fails
        for a given reason, the Host must deny the Requester
        access to the desired resource.
        In this case the Host must forward to the Requester the error message
        generated by the AM.  The Host may also
        provide additional error messages to the Requester.</t>
      </section>
      

    </section>



    <section title="Scopes">
      
      <t>(NOTE: we need an entire section devoted to scopes.
      Putting scopes discussion in the Phases sections will
      convolute the flow discussions.</t>
      
      


    </section>





    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --> 
    
    
  <section title="Error Messages">
      <t>Ultimately the host is responsible for either granting the access
        the requester attempted, or returning an error response to the
        requester with a reason for the failure. <xref target="OAuth2" />
        defines several error responses for a resource server to return. UMA
        makes use of these error responses, but requires the host to
        "outsource" the determination of some error conditions to the AM.</t>
      
      <t>The host is responsible for determining "insufficient_scope". If
        the requester's attempted access does not match any of the scopes
        returned by the AM in its valid-token response to the host, the host
        returns an "insufficient_scope" error to the requester.</t>
      
      <t>The host is responsible for determining "invalid_request". If the
        requester's request was badly formed, the host returns an
        "invalid_request" error to the requester.</t>
      
      <t>If the AM determined that the requester access token is invalid, it
        returns an "invalid_requester_token" error response to the host.
        [@@TBS: Need to flesh out more and provide an example.] The host then
        returns an "invalid_token" response to the requester as described in
        section 5.2.1 of <xref target="OAuth2" />.</t>
      
      <t>If the AM determined that the requester access token has expired,
        it returns an "expired_requester_token" error response to the host.
        [@@TBS: Need to flesh out more and provide an example.] The host then
        returns an "invalid_token" response to the requester as described in
        section 5.2.1 of <xref target="OAuth2" />.</t>
      
      <t>If the host's token validation request message itself was badly
        formed, the AM returns an "invalid_request" error to the host. [@@Need
        to say what happens to the requester after that?]</t>
  </section>
    
    
    
    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --> 
    
    <section title="Security Considerations">
      <t>@@TODO: Provide commentary on any requirements layered on the
      forthcoming OAuth security considerations section; discuss UMA-layer
      implications for more meaningful authentication of requesters/requesting
      parties; discuss implications of user-mediated AM/host trust model;
      discuss short-lived token technique for lightweight requester
      correlation...</t>
    </section>



    <!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx --> 

    <section title="Conformance">
      <t>This section outlines conformance requirements for various entities
      implementing UMA endpoints. Currently two levels of conformance are
      defined: minimal and full. (Other types or levels may ultimately be
      defined in this specification or in other specifications that profile or
      extend this one.)</t>

      <t>This specification has dependencies on other specifications, as
      follows:<list style="symbols">
          <t>OAuth 2.0: AMs, hosts, and requesters MUST support OAuth 2.0
          features named in this specification for minimal conformance. For
          example, features related to refresh tokens, client secrets, and the
          web server profile are mentioned and support for them is
          REQUIRED.</t>

          <t>Dynamic registration: For full conformance, AMs MUST support
          dynamic registration. For minimal conformance, AMs are not required
          to support dynamic registration. Hosts need not support the
          requesting of dynamic registration at either conformance level.</t>

          <t>Resource registration: For minimal conformance, AMs and hosts
          MUST support resource registration.</t>
        </list></t>
    </section>
    

    
    <!-- Possibly a 'Contributors' section ... -->
    
    <section anchor="IANA" title="IANA Considerations">
      <t>TBD</t>
    </section>
    
    <section anchor="Security" title="Security Considerations">
      <t>TBD</t>
      
      <t>All drafts are required to have a security considerations section.
        See <xref target="RFC3552">RFC 3552</xref> for a guide.</t>
    </section>
    
    <section anchor="Acknowledgements" title="Acknowledgements">
      <t>List of UMA contributors</t>
    </section>
    
    

    
  </middle>


  <!--  *****BACK MATTER ***** -->
  
  <back>
    <references title="Normative References">
      
      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.2617.xml' ?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml' ?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml/reference.RFC.5785.xml' ?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-hammer-hostmeta-13.xml'?>

      <?rfc include='http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-ietf-httpbis-p1-messaging-09.xml'?>
      

       <reference anchor="OAuth2"
            target="http://www.ietf.org/id/draft-ietf-oauth-v2-10.txt">
            <front>
               <title>The OAuth 2.0 Protocol</title>
               <author initials="E." surname="Hammer-Lahav">
               <organization>IETF</organization>
               </author>
              <date year="2010" />
            </front>
       </reference>
      
       <reference anchor="Dyn-Reg"
       target="http://tools.ietf.org/html/draft-oauth-dyn-reg-v1-00">
            <front>
                <title>OAuth Dynamic Client Registration Protocol</title>
                <author initials="C." surname="Scholz">
                    <organization>IETF</organization>
                </author>
                <date year="2010" />
            </front>
       </reference>
      
       <reference anchor="hostmeta"
       target="http://xml.resource.org/public/rfc/bibxml3/reference.I-D.draft-hammer-hostmeta-13.xml">
              <front>
                <title>Web Host Metadata</title>
                <author initials="E." surname="Hammer-Lahav">
                 <organization>Yahoo!</organization>
                </author>
                <date year="2010" />
              </front>
        </reference>

        <reference anchor="Claims2.0"
              target="http://wguma.org/confluence/display/uma/Claims+2.0">
              <front>
                  <title>Claims 2.0</title>
                  <author initials="E." surname="Maler">
                  <organization>Kantara</organization>
                  </author>
                  <date year="2010" />
              </front>
        </reference>
      
      <reference anchor="ID-ietf-httpbis-p1-messaging"
        target="http://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14">
        <front>
          <title>http://tools.ietf.org/html/draft-ietf-httpbis-p1-messaging-14</title>
          <author initials="R." surname="Fielding">
            <organization>IETF</organization>
          </author>
          <date year="2011" />
        </front>
      </reference>
      
    </references>
    
    <references title="Informative References">
        <!-- Here we use entities that we defined at the beginning. -->
      
      &RFC3552;
      

    </references>
    
    
    <section anchor="History" title="Document History">
      <t>NOTE: To be removed by RFC editor before publication as an RFC</t>
      

        <t>Changes in Rev 6:
          <list style="symbols">
            <t>Now only using two phases.</t>
            <t>Merged Phase III into Phase II, and removed
              duplication of steps.</t>
            <t>Revised the Introduction section.</t>
            <t>Introduced examples section (TBD).</t>
            
          </list></t>
        
        <t>Changes in Rev 5:
          <list style="symbols">
            <t>Placed Etherpad items into Section 3.</t>
            <t>Used Phases (instead of stepa and substeps).</t>
          </list></t>

    </section>
    
  </back>
</rfc>
